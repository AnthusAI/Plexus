<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Human-in-the-Loop Guide - Plexus Procedure DSL</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header .breadcrumb {
            opacity: 0.9;
        }

        .header .breadcrumb a {
            color: white;
            text-decoration: none;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        .content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        h2 {
            color: #667eea;
            margin: 2rem 0 1rem 0;
            font-size: 1.8rem;
        }

        h3 {
            color: #764ba2;
            margin: 1.5rem 0 0.5rem 0;
            font-size: 1.3rem;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .tip-box {
            background: #f1f8e9;
            border-left: 4px solid #8bc34a;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .example {
            background: #f9f9f9;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        code {
            background: #f4f4f4;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }

        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
        }

        li {
            margin: 0.5rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .pattern-card {
            background: #f9f9f9;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            border-left: 4px solid #764ba2;
        }

        .pattern-card h4 {
            color: #764ba2;
            margin-bottom: 0.5rem;
        }

        .nav-links {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #ddd;
        }

        .nav-links a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .nav-links a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="breadcrumb">
            <a href="index.html">Documentation</a> / Human-in-the-Loop Guide
        </div>
        <h1>Human-in-the-Loop (HITL)</h1>
    </div>

    <div class="container">
        <div class="content">
            <h2>Introduction</h2>
            <p>
                Human-in-the-Loop (HITL) enables procedures to collaborate with human operators.
                Instead of running fully autonomously, procedures can request approval before
                critical operations, gather input, submit work for review, send progress updates,
                and escalate when stuck.
            </p>

            <p>
                HITL is a first-class feature in Plexus Procedures, not an afterthought. The primitives
                are built directly into the workflow control flow, making human collaboration as
                natural as calling an agent turn.
            </p>

            <h2>Core Principles</h2>
            <ul>
                <li><strong>Blocking by default:</strong> Approval, input, and review operations block workflow execution</li>
                <li><strong>Non-blocking notifications:</strong> Progress updates and alerts don't block execution</li>
                <li><strong>Timeout support:</strong> All blocking operations support timeouts with fallback behavior</li>
                <li><strong>Context-rich:</strong> Provide structured data to help humans make informed decisions</li>
                <li><strong>Stage integration:</strong> Procedure status reflects when waiting for human interaction</li>
            </ul>

            <h2>HITL Primitives</h2>

            <h3>1. Approval (Blocking)</h3>
            <p>Request yes/no approval before proceeding:</p>

            <div class="code-block">local approved = Human.approve({
  message = "Deploy to production?",
  context = {
    version = "2.1.0",
    environment = "production",
    changes = {
      "Fixed authentication bug",
      "Updated dependencies",
      "Performance improvements"
    }
  },
  timeout = 3600,  -- 1 hour in seconds
  default = false
})</div>

            <div class="info-box">
                <strong>Parameters:</strong>
                <ul>
                    <li><code>message</code> - Question to ask (string, required)</li>
                    <li><code>context</code> - Structured data for decision-making (table, optional)</li>
                    <li><code>timeout</code> - Seconds to wait (number, nil = forever)</li>
                    <li><code>default</code> - Return value if timeout (boolean)</li>
                    <li><code>on_timeout</code> - Behavior: "default", "error", "retry"</li>
                </ul>
                <strong>Returns:</strong> <code>true</code> or <code>false</code>
            </div>

            <div class="example">
                <h4>Complete Example</h4>
                <div class="code-block">workflow: |
  -- Perform analysis
  Stage.set("analyzing")
  Worker.turn()

  -- Request approval with context
  Stage.set("awaiting_approval")
  local approved = Human.approve({
    message = "Approve deployment?",
    context = {
      analysis = State.get("analysis"),
      risk_level = State.get("risk_level"),
      affected_systems = State.get("affected_systems")
    },
    timeout = 7200,
    default = false
  })

  if approved then
    Stage.set("deploying")
    deploy()
    Human.notify({message = "Deployment complete", level = "info"})
  else
    Log.info("Deployment cancelled by operator")
  end</div>
            </div>

            <h3>2. Input (Blocking)</h3>
            <p>Request free-form text input from human:</p>

            <div class="code-block">local topic = Human.input({
  message = "What topic should I research next?",
  placeholder = "Enter a topic...",
  timeout = nil  -- Wait forever
})

if topic then
  Procedure.run("researcher", {topic = topic})
else
  Log.warn("No input received")
end</div>

            <div class="info-box">
                <strong>Parameters:</strong>
                <ul>
                    <li><code>message</code> - Prompt for input (string, required)</li>
                    <li><code>placeholder</code> - UI hint text (string, optional)</li>
                    <li><code>timeout</code> - Seconds to wait (number, nil = forever)</li>
                    <li><code>default</code> - Return value if timeout (string)</li>
                </ul>
                <strong>Returns:</strong> String or <code>nil</code>
            </div>

            <div class="example">
                <h4>Interactive Research</h4>
                <div class="code-block">workflow: |
  -- Get initial topic
  local topic = Human.input({
    message = "What would you like me to research?",
    placeholder = "Enter topic (e.g., quantum computing)"
  })

  if not topic then
    return {error = "No topic provided"}
  end

  -- Research
  Worker.turn({inject = "Research: " .. topic})

  -- Ask for refinement
  local refinement = Human.input({
    message = "Any specific aspect to focus on?",
    placeholder = "Optional: enter focus area",
    timeout = 300,
    default = "general"
  })

  if refinement ~= "general" then
    Worker.turn({inject = "Focus on: " .. refinement})
  end</div>
            </div>

            <h3>3. Review (Blocking)</h3>
            <p>Request human review of a work product:</p>

            <div class="code-block">local review = Human.review({
  message = "Please review this generated report",
  artifact = report_content,
  artifact_type = "document",  -- document, code, config, data
  options = {"approve", "edit", "reject"},
  timeout = 86400  -- 24 hours
})

if review.decision == "approve" then
  publish(report_content)
elseif review.decision == "edit" then
  -- Use human's edited version
  publish(review.edited_artifact)
else
  Log.warn("Report rejected", {feedback = review.feedback})
  return {published = false, reason = review.feedback}
end</div>

            <div class="info-box">
                <strong>Parameters:</strong>
                <ul>
                    <li><code>message</code> - Review request (string, required)</li>
                    <li><code>artifact</code> - Work product to review (string, required)</li>
                    <li><code>artifact_type</code> - Type hint for UI (string, optional)</li>
                    <li><code>options</code> - Decision options (array, optional)</li>
                    <li><code>timeout</code> - Seconds to wait (number, nil = forever)</li>
                </ul>
                <strong>Returns:</strong> Table with:
                <ul>
                    <li><code>decision</code> - Selected option</li>
                    <li><code>edited_artifact</code> - Modified version (if edited)</li>
                    <li><code>feedback</code> - Human comments</li>
                </ul>
            </div>

            <h3>4. Notification (Non-Blocking)</h3>
            <p>Send information without waiting:</p>

            <div class="code-block">Human.notify({
  message = "Processing phase 2 of 5",
  level = "info",  -- info, warning, error
  context = {
    progress = "40%",
    items_processed = 200,
    items_remaining = 300
  }
})

-- Execution continues immediately</div>

            <div class="info-box">
                <strong>Parameters:</strong>
                <ul>
                    <li><code>message</code> - Notification text (string, required)</li>
                    <li><code>level</code> - Severity: "info", "warning", "error" (string, optional)</li>
                    <li><code>context</code> - Additional data (table, optional)</li>
                </ul>
                <strong>Returns:</strong> Nothing (non-blocking)
            </div>

            <div class="example">
                <h4>Progress Notifications</h4>
                <div class="code-block">workflow: |
  Human.notify({message = "Starting batch processing", level = "info"})

  local total = #params.items
  for i, item in ipairs(params.items) do
    process(item)

    -- Notify every 10%
    if i % math.floor(total / 10) == 0 then
      local percent = math.floor((i / total) * 100)
      Human.notify({
        message = "Progress: " .. percent .. "%",
        level = "info",
        context = {processed = i, total = total}
      })
    end
  end

  Human.notify({message = "Batch processing complete", level = "info"})</div>
            </div>

            <h3>5. Alert (Non-Blocking, System-Level)</h3>
            <p>Send system monitoring alerts:</p>

            <div class="code-block">System.alert({
  message = "Memory usage exceeded threshold",
  level = "warning",  -- info, warning, error, critical
  source = "batch_processor",
  context = {
    memory_mb = 8500,
    threshold_mb = 8000,
    procedure_id = context.procedure_id
  }
})</div>

            <div class="info-box">
                <strong>Parameters:</strong>
                <ul>
                    <li><code>message</code> - Alert text (string, required)</li>
                    <li><code>level</code> - Severity: "info", "warning", "error", "critical" (string, required)</li>
                    <li><code>source</code> - Component identifier (string, required)</li>
                    <li><code>context</code> - Structured data (table, optional)</li>
                </ul>
                <strong>Returns:</strong> Nothing (non-blocking)
            </div>

            <div class="warning-box">
                <strong>Difference from Human.notify:</strong>
                <ul>
                    <li><strong>Alerts</strong> are for system-level events (errors, resource warnings, monitoring)</li>
                    <li><strong>Notifications</strong> are for workflow-level progress updates</li>
                    <li>Alerts have a <code>source</code> field for categorization</li>
                    <li>Alerts can be sent from anywhere (not just procedures)</li>
                </ul>
            </div>

            <h3>6. Escalation (Blocking)</h3>
            <p>Hand off to human when stuck:</p>

            <div class="code-block">if attempts > 3 then
  Human.escalate({
    message = "Unable to resolve issue automatically",
    context = {
      attempts = attempts,
      last_error = last_error,
      current_state = State.all(),
      recommendations = {
        "Check network connectivity",
        "Verify credentials",
        "Review error logs"
      }
    }
  })
  -- Procedure pauses until human resolves and resumes
end</div>

            <div class="info-box">
                <strong>Parameters:</strong>
                <ul>
                    <li><code>message</code> - Escalation reason (string, required)</li>
                    <li><code>context</code> - All relevant debugging info (table, required)</li>
                </ul>
                <strong>Behavior:</strong>
                <ul>
                    <li>Procedure pauses completely</li>
                    <li>Human sees all context and can inspect state</li>
                    <li>Human can modify state, inject guidance, or abort</li>
                    <li>Procedure resumes when human signals</li>
                </ul>
            </div>

            <h2>Timeout Handling</h2>

            <p>All blocking HITL operations support timeouts:</p>

            <h3>Basic Timeout with Default</h3>
            <div class="code-block">local approved = Human.approve({
  message = "Approve?",
  timeout = 3600,
  default = false
})
-- After 1 hour, returns false</div>

            <h3>Detecting Timeout</h3>
            <div class="code-block">local approved, timed_out = Human.approve({
  message = "Approve?",
  timeout = 3600
})

if timed_out then
  Log.warn("Request timed out")
  -- approved is nil
end</div>

            <h3>Error on Timeout</h3>
            <div class="code-block">local ok, result = pcall(function()
  return Human.approve({
    message = "Approve?",
    timeout = 3600,
    on_timeout = "error"  -- Throw exception on timeout
  })
end)

if not ok then
  Log.error("Approval timed out: " .. tostring(result))
end</div>

            <h3>Retry on Timeout</h3>
            <div class="code-block">local approved = Human.approve({
  message = "Approve?",
  timeout = 3600,
  on_timeout = "retry"  -- Ask again once
})</div>

            <h2>Declarative HITL Points</h2>

            <p>For predictable workflows, declare HITL points in YAML:</p>

            <div class="code-block">name: content_pipeline
version: 1.0.0

hitl:
  review_draft:
    type: review
    message: "Review the generated content"
    timeout: 86400
    options: [approve, edit, reject]

  confirm_publish:
    type: approval
    message: "Publish to production?"
    timeout: 3600
    default: false

  get_feedback:
    type: input
    message: "Any feedback on the draft?"
    placeholder: "Enter feedback..."

workflow: |
  -- Generate draft
  Worker.turn()
  local draft = State.get("draft")

  -- Use declared review point
  local review = Human.review("review_draft", {
    artifact = draft
  })

  -- Use declared approval point
  if review.decision == "approve" then
    local approved = Human.approve("confirm_publish")
    if approved then
      publish(draft)
    end
  end</div>

            <div class="tip-box">
                <strong>Benefits of declarative HITL:</strong>
                <ul>
                    <li>Self-documenting (points visible in YAML)</li>
                    <li>Reusable configuration across workflow runs</li>
                    <li>Type safety (validates options)</li>
                    <li>Easier to maintain and update</li>
                </ul>
            </div>

            <h2>HITL and Stages</h2>

            <p>When waiting for human interaction, procedure status reflects this:</p>

            <div class="code-block">workflow: |
  Stage.set("processing")
  Worker.turn()

  -- Status shows waiting_for_human = true during this call
  local approved = Human.approve({message = "Continue?"})

  Stage.set("finalizing")
  finalize()</div>

            <p>Parent procedures can detect waiting state:</p>

            <div class="code-block">workflow: |
  -- Spawn child procedure
  local handle = Procedure.spawn("deployment", params)

  -- Check status periodically
  while not Procedure.is_complete(handle) do
    local status = Procedure.status(handle)

    if status.waiting_for_human then
      -- Maybe notify via Slack
      notify_slack("Deployment waiting for approval")
    end

    Sleep(30)
  end

  local result = Procedure.result(handle)</div>

            <h2>Common Patterns</h2>

            <div class="pattern-card">
                <h4>Pattern: Pre-Action Approval</h4>
                <p>Request approval before critical operations:</p>
                <div class="code-block">workflow: |
  -- Prepare operation
  Stage.set("preparing")
  analyze_impact()

  -- Request approval
  local approved = Human.approve({
    message = "Execute database migration?",
    context = {
      affected_tables = State.get("affected_tables"),
      estimated_duration = "15 minutes",
      rollback_plan = "Available"
    },
    timeout = 1800
  })

  if approved then
    Stage.set("executing")
    migrate_database()
  else
    Log.info("Migration cancelled")
  end</div>
            </div>

            <div class="pattern-card">
                <h4>Pattern: Review-Edit-Approve</h4>
                <p>Generate work product, allow editing, then approve:</p>
                <div class="code-block">workflow: |
  -- Generate
  Worker.turn()
  local draft = State.get("draft")

  -- Review (with editing)
  local review = Human.review({
    message = "Review and edit if needed",
    artifact = draft,
    artifact_type = "document",
    options = {"approve", "edit", "reject"}
  })

  if review.decision == "reject" then
    return {published = false}
  end

  -- Use edited or original version
  local final = review.edited_artifact or draft

  -- Final approval
  local approved = Human.approve({
    message = "Publish this version?",
    context = {preview = final:sub(1, 200)}
  })

  if approved then
    publish(final)
  end</div>
            </div>

            <div class="pattern-card">
                <h4>Pattern: Progressive Disclosure</h4>
                <p>Gather input in stages as needed:</p>
                <div class="code-block">workflow: |
  -- Initial input
  local query = Human.input({
    message = "What would you like to search for?",
    placeholder = "Enter search query"
  })

  -- Search
  Worker.turn({inject = "Search for: " .. query})
  local results = State.get("results")

  -- Follow-up based on results
  if #results > 100 then
    local filter = Human.input({
      message = "Found " .. #results .. " results. How to filter?",
      placeholder = "e.g., 'published after 2020'"
    })

    if filter then
      Worker.turn({inject = "Filter by: " .. filter})
    end
  end</div>
            </div>

            <div class="pattern-card">
                <h4>Pattern: Error Recovery</h4>
                <p>Request human intervention on errors:</p>
                <div class="code-block">workflow: |
  local attempts = 0
  local max_attempts = 3

  while attempts < max_attempts do
    local ok, result = pcall(risky_operation)

    if ok then
      return {success = true, result = result}
    end

    attempts = attempts + 1
    Log.error("Attempt " .. attempts .. " failed")

    if attempts >= max_attempts then
      -- Escalate to human
      local action = Human.input({
        message = "Operation failed after 3 attempts. How to proceed?",
        placeholder = "retry / abort / manual",
        context = {error = result}
      })

      if action == "retry" then
        attempts = 0
      elseif action == "manual" then
        Human.escalate({
          message = "Manual intervention required",
          context = {error = result}
        })
      else
        return {success = false, error = result}
      end
    end
  end</div>
            </div>

            <div class="pattern-card">
                <h4>Pattern: Progress with Alerts</h4>
                <p>Monitor long operations and alert on issues:</p>
                <div class="code-block">workflow: |
  Human.notify({message = "Starting batch job", level = "info"})

  local processed = 0
  local failed = 0
  local total = #params.items

  for i, item in ipairs(params.items) do
    local ok = process(item)

    if ok then
      processed = processed + 1
    else
      failed = failed + 1
    end

    -- Alert if failure rate too high
    local failure_rate = failed / i
    if failure_rate > 0.1 and i > 10 then
      System.alert({
        message = "High failure rate detected",
        level = "warning",
        source = "batch_processor",
        context = {
          failure_rate = failure_rate,
          processed = i,
          failed = failed
        }
      })

      -- Ask whether to continue
      local continue = Human.approve({
        message = "Failure rate is " .. (failure_rate * 100) .. "%. Continue?",
        default = false,
        timeout = 300
      })

      if not continue then
        break
      end
    end

    -- Progress notification every 100 items
    if i % 100 == 0 then
      Human.notify({
        message = "Progress: " .. i .. "/" .. total,
        level = "info"
      })
    end
  end

  Human.notify({
    message = "Batch complete",
    level = "info",
    context = {processed = processed, failed = failed}
  })</div>
            </div>

            <h2>Best Practices</h2>

            <div class="tip-box">
                <strong>DO:</strong>
                <ul>
                    <li>Provide rich context for decision-making</li>
                    <li>Set reasonable timeouts (don't wait forever)</li>
                    <li>Use notifications for progress updates</li>
                    <li>Use alerts for system-level monitoring</li>
                    <li>Escalate when truly stuck</li>
                    <li>Structure context data clearly</li>
                    <li>Give humans actionable options</li>
                </ul>
            </div>

            <div class="warning-box">
                <strong>DON'T:</strong>
                <ul>
                    <li>Over-notify (causes notification fatigue)</li>
                    <li>Request approval for trivial operations</li>
                    <li>Omit context (humans need info to decide)</li>
                    <li>Use blocking calls in high-throughput paths</li>
                    <li>Mix alerts and notifications inappropriately</li>
                    <li>Forget to handle timeout cases</li>
                </ul>
            </div>

            <h2>Complete Example</h2>

            <p>Putting it all together in a content pipeline:</p>

            <div class="code-block">name: content_pipeline
version: 1.0.0
description: Generate, review, and publish content with human oversight

params:
  topic:
    type: string
    required: true
  target:
    type: string
    enum: [blog, docs, social]
    required: true

outputs:
  published:
    type: boolean
    required: true
  url:
    type: string
    required: false

stages:
  - drafting
  - review
  - publishing
  - complete

hitl:
  review_content:
    type: review
    message: "Review the generated content"
    timeout: 86400
    options: [approve, edit, reject]

  confirm_publish:
    type: approval
    message: "Publish to {params.target}?"
    timeout: 3600
    default: false

agents:
  writer:
    system_prompt: |
      Write content about: {params.topic}
      Target: {params.target}
    tools: [research, write, done]

workflow: |
  -- Notify start
  Human.notify({
    message = "Starting content generation",
    level = "info",
    context = {topic = params.topic, target = params.target}
  })

  -- Generate draft
  Stage.set("drafting")
  repeat
    Writer.turn()
  until Tool.called("done") or Iterations.exceeded(20)

  local draft = State.get("draft")
  if not draft then
    System.alert({
      message = "Failed to generate draft",
      level = "error",
      source = "content_pipeline"
    })
    return {published = false, error = "No draft generated"}
  end

  -- Human review
  Stage.set("review")
  local review = Human.review("review_content", {
    artifact = draft,
    artifact_type = "document"
  })

  if review.decision == "reject" then
    Human.notify({
      message = "Content rejected",
      level = "warning",
      context = {feedback = review.feedback}
    })
    return {published = false, reason = "rejected"}
  end

  -- Use edited or original
  local final_content = review.edited_artifact or draft

  -- Approval to publish
  Stage.set("publishing")
  local approved = Human.approve("confirm_publish", {
    context = {
      content_length = #final_content,
      estimated_read_time = math.ceil(#final_content / 1000) .. " min"
    }
  })

  if not approved then
    return {published = false, reason = "not_approved"}
  end

  -- Publish
  local url = publish_content(final_content, params.target)

  -- Notify success
  Human.notify({
    message = "Content published successfully",
    level = "info",
    context = {url = url, target = params.target}
  })

  Stage.set("complete")
  return {published = true, url = url}</div>

            <div class="nav-links">
                <a href="getting-started.html">← Getting Started</a>
                <a href="examples.html">Examples & Patterns →</a>
            </div>
        </div>
    </div>
</body>
</html>
